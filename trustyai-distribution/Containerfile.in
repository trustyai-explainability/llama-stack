FROM registry.access.redhat.com/ubi9/python-312:latest
WORKDIR /opt/app-root

# Switch to root for package installation
USER root
RUN pip install sqlalchemy # somehow sqlalchemy[asyncio] is not sufficient
{dependencies}
RUN pip install --no-cache llama-stack==0.2.22

# chown the work directories to the non-root user to create garak scan log files
RUN chown -R 1001:1001 ${{APP_ROOT}}
# FIXME: Temporary fix for Garak's permissions
# Make the Garak provider package directory writable for scan files
RUN mkdir -p /opt/app-root/lib64/python3.12/site-packages/llama_stack_provider_trustyai_garak/_scan_files && \
    chown -R 1001:1001 /opt/app-root/lib64/python3.12/site-packages/llama_stack_provider_trustyai_garak
# Create Garak directories with full permissions (world-writable for debugging)
RUN mkdir -p ${{APP_ROOT}}/src/.config/garak ${{APP_ROOT}}/src/.local/share/garak ${{APP_ROOT}}/src/.cache/garak/resources && \
    chmod -R 777 ${{APP_ROOT}}/src/.config ${{APP_ROOT}}/src/.local ${{APP_ROOT}}/src/.cache && \
    chown -R 1001:0 ${{APP_ROOT}}/src/.config ${{APP_ROOT}}/src/.local ${{APP_ROOT}}/src/.cache
# Switch back to non-root user
USER 1001
RUN mkdir -p ${{HOME}}/.llama ${{HOME}}/.cache
COPY trustyai-distribution/run.yaml ${{APP_ROOT}}/run.yaml

ENTRYPOINT ["python", "-m", "llama_stack.core.server.server", "/opt/app-root/run.yaml"]
