# WARNING: This file is auto-generated. Do not modify it manually.
# Generated by: trustyai-distribution/build.py

FROM registry.access.redhat.com/ubi9/python-312:latest
WORKDIR /opt/app-root

# Switch to root for package installation
USER root
RUN pip install sqlalchemy # somehow sqlalchemy[asyncio] is not sufficient
RUN pip install \
    aiosqlite \
    asyncpg \
    autoevals \
    chardet \
    'datasets>=4.0.0' \
    fastapi \
    fire \
    httpx \
    matplotlib \
    'mcp>=1.8.1' \
    nltk \
    numpy \
    opentelemetry-exporter-otlp-proto-http \
    opentelemetry-sdk \
    pandas \
    pillow \
    psycopg2-binary \
    'pymilvus[milvus-lite]>=2.4.10' \
    pymongo \
    pypdf \
    redis \
    requests \
    scikit-learn \
    scipy \
    sentencepiece \
    sqlalchemy[asyncio] \
    tqdm \
    transformers \
    uvicorn
RUN pip install \
    llama_stack_provider_lmeval==0.2.4
RUN pip install \
    llama_stack_provider_ragas==0.3.0
RUN pip install \
    llama_stack_provider_ragas[remote]==0.3.0
RUN pip install \
    llama_stack_provider_trustyai_fms==0.2.2
RUN pip install \
    llama_stack_provider_trustyai_garak==0.1.4
RUN pip install \
    llama_stack_provider_trustyai_garak[remote]==0.1.4
RUN pip install --extra-index-url https://download.pytorch.org/whl/cpu torch 'torchao>=0.12.0' torchvision
RUN pip install --no-deps sentence-transformers
RUN pip install --no-cache llama-stack==0.2.22

# chown the work directories to the non-root user to create garak scan log files
RUN chown -R 1001:1001 ${APP_ROOT}
# Switch back to non-root user
USER 1001
RUN mkdir -p ${HOME}/.llama ${HOME}/.cache
COPY trustyai-distribution/run.yaml ${APP_ROOT}/run.yaml

ENTRYPOINT ["python", "-m", "llama_stack.core.server.server", "/opt/app-root/run.yaml"]
